#!/bin/bash

source "$HOME/.config/sketchybar/colors.sh" # Loads all defined colors
source "$HOME/.config/sketchybar/icons.sh" # Loads all defined icons

ITEM_DIR="$HOME/.config/sketchybar/items" # Directory where the items are configured
PLUGIN_DIR="$HOME/.config/sketchybar/plugins" # Directory where all the plugin scripts are stored

FONT="SF Pro" # Needs to have Regular, Bold, Semibold, Heavy and Black variants
PADDINGS=3 # All paddings use this value (icon, label, background)

 Setting up and starting the helper process
  HELPER=git.felix.helper
  killall helper
  cd $HOME/.config/sketchybar/helper && make
  $HOME/.config/sketchybar/helper/helper $HELPER > /dev/null 2>&1 &

# Unload the macOS on screen indicator overlay for volume change
launchctl unload -F /System/Library/LaunchAgents/com.apple.OSDUIHelper.plist > /dev/null 2>&1 &

# Setting up the general bar appearance of the bar
  bar=(
      height=39
      color=$BAR_COLOR
      shadow=on
      position=top
      sticky=on
      padding_right=10
      padding_left=10
      corner_radius=9
      y_offset=10
      margin=10
      blur_radius=20
      notch_width=0
      )

  sketchybar --bar "${bar[@]}"

# Setting up default values
  defaults=(
      updates=when_shown
      icon.font="Hack Nerd Font:Bold:17.0"
       label.font="SF Pro:Semibold:17.0"
      icon.color=$ICON_COLOR
      icon.padding_left=$PADDINGS
      icon.padding_right=$PADDINGS
      label.color=$LABEL_COLOR
      label.padding_left=$PADDINGS
      label.padding_right=$PADDINGS
      padding_right=$PADDINGS
      padding_left=$PADDINGS
      background.height=30
      background.corner_radius=9
      popup.background.border_width=2
      popup.background.corner_radius=9
      popup.background.border_color=$POPUP_BORDER_COLOR
      popup.background.color=$POPUP_BACKGROUND_COLOR
      popup.blur_radius=20
      popup.background.shadow.drawing=on
      )

  sketchybar --default "${defaults[@]}"

# Left
  source "$ITEM_DIR/apple.sh"
#  source "$ITEM_DIR/spaces.sh"
##### Adding aeropsace layouts #####

# Add the aerospace_workspace_change event we specified in aerospace.toml
sketchybar --add event aerospace_workspace_change
# Detect number of monitors
monitor_count="$(aerospace list-monitors --format "%{monitor-appkit-nsscreen-screens-id}" | wc -l | tr -d ' ')"
# Optional: single-monitor UI tweaks (adjust to taste)
if [ "$monitor_count" -eq 1 ]; then
  BG_COLOR="0x66ffffff"
  BG_HEIGHT=28
  LABEL_FONT="sketchybar-app-font:Regular:15.0"
  SINGLE_MONITOR_MODE=1
else
  BG_COLOR="0x44ffffff"
  BG_HEIGHT=25
  LABEL_FONT="sketchybar-app-font:Regular:16.0"
  SINGLE_MONITOR_MODE=0
fi
# Add workspaces for all monitors
for monitor in $(aerospace list-monitors --format "%{monitor-appkit-nsscreen-screens-id}"); do

  for sid in $(aerospace list-workspaces --monitor "$monitor"); do

    sketchybar --add item space.$sid left \
      --set space.$sid display="$monitor" \
      --subscribe space.$sid aerospace_workspace_change \
      --set space.$sid \
      drawing=on \
      background.color=0x44ffffff \
      background.corner_radius=5 \
      background.drawing=on \
      background.border_color=0xAAFFFFFF \
      background.border_width=0 \
      background.height=25 \
      icon="$sid" \
      icon.padding_left=10 \
      icon.shadow.distance=4 \
      icon.shadow.color=0xA0000000 \
      label.font="sketchybar-app-font:Regular:16.0" \
      label.padding_right=20 \
      label.padding_left=0 \
      label.y_offset=-1 \
      label.shadow.drawing=off \
      label.shadow.color=0xA0000000 \
      label.shadow.distance=4 \
      click_script="aerospace workspace $sid" \
      script="$CONFIG_DIR/plugins/aerospace.sh $sid"
  done
done



# Load Icons on startup for all monitors
for monitor in $(aerospace list-monitors); do
  for sid in $(aerospace list-workspaces --monitor "$monitor" --empty no); do
    apps=$(aerospace list-windows --workspace "$sid" | awk -F'|' '{gsub(/^ *| *$/, "", $2); print $2}')

    sketchybar --set space.$sid drawing=on

    icon_strip=" "
    if [ "${apps}" != "" ]; then
      while read -r app; do
        icon_strip+=" $($CONFIG_DIR/plugins/icon_map.sh "$app")"
      done <<<"${apps}"
    else
      icon_strip=""
    fi
    sketchybar --set space.$sid label="$icon_strip"
  done
done


# Center
  # source "$ITEM_DIR/spotify.sh"

# Right
  source "$ITEM_DIR/calendar.sh"
  source "$ITEM_DIR/brew.sh"
  source "$ITEM_DIR/github.sh"
  source "$ITEM_DIR/battery.sh"
  source "$ITEM_DIR/volume.sh"
  source "$ITEM_DIR/cpu.sh"

# Forcing all item scripts to run (never do this outside of sketchybarrc)
sketchybar --update

echo "sketchybar configuation loaded.."
